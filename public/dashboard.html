<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NAS100 cTrader Bot Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --text-color: #f8fafc;
            --accent-color: #3b82f6;
            --success-color: #22c55e;
            --danger-color: #ef4444;
            --warning-color: #eab308;
            --purple-color: #8b5cf6;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .header {
            text-align: center;
            padding: 20px;
            background: var(--card-bg);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header h1 {
            margin: 0;
            font-size: 1.5rem;
            background: linear-gradient(45deg, #3b82f6, #8b5cf6);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            color: transparent;
            display: inline-block;
        }

        .status-row {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .status-connected {
            background: rgba(34, 197, 94, 0.2);
            color: var(--success-color);
        }

        .status-disconnected {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger-color);
        }

        .status-watching {
            background: rgba(59, 130, 246, 0.2);
            color: var(--accent-color);
        }

        .status-idle {
            background: rgba(100, 116, 139, 0.2);
            color: #94a3b8;
        }

        .price-display {
            text-align: center;
            font-size: 3rem;
            font-family: 'Roboto Mono', monospace;
            margin: 10px 0;
            font-weight: 700;
        }

        .card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .card-label {
            font-size: 0.9rem;
            color: #94a3b8;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
        }

        .stat-item {
            background: rgba(0, 0, 0, 0.2);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-label {
            font-size: 0.75rem;
            color: #64748b;
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 1.2rem;
            font-weight: 700;
        }

        .text-green {
            color: var(--success-color);
        }

        .text-red {
            color: var(--danger-color);
        }

        .text-blue {
            color: var(--accent-color);
        }

        .params-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 12px;
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            font-size: 0.7rem;
            color: #64748b;
            margin-bottom: 4px;
        }

        .form-group input {
            width: 100%;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #334155;
            background: #0f172a;
            color: white;
            font-size: 0.9rem;
        }

        button {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s, transform 0.1s;
            font-size: 0.9rem;
        }

        button:hover {
            opacity: 0.9;
        }

        button:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: var(--accent-color);
            color: white;
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-warning {
            background: var(--warning-color);
            color: black;
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--accent-color);
            color: var(--accent-color);
        }

        .actions-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .position-card {
            background: rgba(0, 0, 0, 0.2);
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            gap: 12px;
        }

        .position-long {
            border-left-color: var(--success-color);
        }

        .position-short {
            border-left-color: var(--danger-color);
        }

        .position-info {
            flex: 1;
        }

        .position-type {
            font-weight: 700;
            font-size: 1.1rem;
        }

        .position-details {
            font-size: 0.85rem;
            color: #94a3b8;
            margin-top: 4px;
        }

        .position-pnl {
            text-align: right;
            flex-shrink: 0;
        }

        .pnl-value {
            font-size: 1.1rem;
            font-weight: 700;
        }

        .position-id {
            font-size: 0.7rem;
            color: #64748b;
            margin-top: 2px;
        }

        .btn-close-position {
            background: #ef4444;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            flex-shrink: 0;
        }

        .btn-close-position:hover {
            background: #dc2626;
        }

        .log-container {
            background: #000;
            padding: 15px;
            border-radius: 12px;
            font-family: 'Roboto Mono', monospace;
            height: 200px;
            overflow-y: auto;
            font-size: 0.8rem;
            color: #33ff33;
        }

        .log-container::-webkit-scrollbar {
            width: 6px;
        }

        .log-container::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        .log-container::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 3px;
        }

        .no-positions {
            text-align: center;
            color: #64748b;
            padding: 20px;
            font-size: 0.9rem;
        }

        @media (max-width: 600px) {
            .price-display {
                font-size: 2.5rem;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤– NAS100 cTrader Bot</h1>
            <div class="status-row">
                <span id="connection-status" class="status-badge status-disconnected">âšª é€£ç·šä¸­...</span>
                <span id="watching-status" class="status-badge status-idle">ğŸ‘ï¸ å¾…æ©Ÿ</span>
                <span id="trade-status" class="status-badge status-idle">ğŸ“Š ä»Šæ—¥æœªäº¤æ˜“</span>
            </div>
        </div>

        <div class="card">
            <div class="card-label">å³æ™‚åƒ¹æ ¼</div>
            <div class="price-display" id="current-price">--</div>
            <div style="text-align: center; font-size: 0.95rem; color: #94a3b8;">
                åŸºæº–é»: <span id="open-price" style="color: white; font-weight: 600;">--</span>
                &nbsp;|&nbsp;
                åƒ¹å·®: <span id="price-diff" style="font-weight: 600;">--</span>
            </div>
        </div>

        <div class="card">
            <div class="card-label">ğŸ“Š å¸³æˆ¶çµ±è¨ˆ</div>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-label">é¤˜é¡</div>
                    <div class="stat-value text-green" id="balance">$--</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">æ·¨å€¼</div>
                    <div class="stat-value" id="equity">$--</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">å·²ç”¨ä¿è­‰é‡‘</div>
                    <div class="stat-value" id="usedMargin">$--</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">å¯ç”¨ä¿è­‰é‡‘</div>
                    <div class="stat-value" id="freeMargin">$--</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">å‹ç‡</div>
                    <div class="stat-value" id="win-rate">--</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">ç¸½å‹å ´</div>
                    <div class="stat-value text-green" id="wins">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">ç¸½æ•—å ´</div>
                    <div class="stat-value text-red" id="losses">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">æ§“æ¡¿</div>
                    <div class="stat-value" id="leverage">--</div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-label">ğŸ“ˆ ç¸¾æ•ˆæ›²ç·š</div>
            <div style="height: 200px;"><canvas id="equity-chart"></canvas></div>
        </div>

        <div class="card">
            <div class="card-label">âš™ï¸ ç­–ç•¥åƒæ•¸<button class="btn-primary" onclick="saveConfig()"
                    style="padding: 6px 12px; font-size: 0.8rem;">ğŸ’¾ å„²å­˜</button></div>
            <div class="params-grid">
                <div class="form-group"><label>Entry Offset</label><input type="number" id="cfg-entryOffset" value="10">
                </div>
                <div class="form-group"><label>Long TP</label><input type="number" id="cfg-longTP" value="8"></div>
                <div class="form-group"><label>Short TP</label><input type="number" id="cfg-shortTP" value="5"></div>
                <div class="form-group"><label>Long SL</label><input type="number" id="cfg-longSL" value="1000"></div>
                <div class="form-group"><label>Short SL</label><input type="number" id="cfg-shortSL" value="1000"></div>
                <div class="form-group"><label>Lot Size</label><input type="number" id="cfg-lotSize" value="0.1"
                        step="0.01"></div>
                <div class="form-group"><label>ç›¯ç›¤é–‹å§‹ (åˆ†)</label><input type="number" id="cfg-minsAfterOpen" value="1"
                        min="0" max="60"></div>
                <div class="form-group"><label>åŸºæº–åç§» (åˆ†)</label><input type="number" id="cfg-baselineOffsetMinutes"
                        value="0" min="0" max="60"></div>
            </div>
        </div>

        <div class="card">
            <div class="card-label">ğŸ® æ“ä½œæ§åˆ¶</div>
            <div class="actions-row">
                <button class="btn-primary" onclick="toggleWatch()">ğŸ‘ï¸ åˆ‡æ›ç›¯ç›¤</button>
                <button class="btn-success" onclick="fetchOpenPrice()">ğŸ“Š å–å¾—åŸºæº–é»</button>
                <button class="btn-warning" onclick="resetDaily()">ğŸ”„ é‡ç½®ä»Šæ—¥ç‹€æ…‹</button>
                <button class="btn-danger" onclick="closeAllPositions()">âš ï¸ ç·Šæ€¥å¹³å€‰</button>
            </div>
        </div>

        <div class="card">
            <div class="card-label"><span>ğŸ“ˆ ç•¶å‰æŒå€‰ (<span id="position-count">0</span>)</span></div>
            <div id="positions-list">
                <div class="no-positions">ç›®å‰ç„¡æŒå€‰</div>
            </div>
        </div>

        <div class="card">
            <div class="card-label">ğŸ“œ å³æ™‚æ—¥èªŒ</div>
            <div class="log-container" id="logs">
                <div>ç­‰å¾…æ—¥èªŒ...</div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = '/api';
        const PRICE_MULTIPLIER = 100000;
        let socket = null, socketConnected = false, lastLogFetch = 0, equityChart = null;

        // ç¯€æµå‡½æ•¸
        function throttle(func, limit) {
            let inThrottle;
            return function (...args) {
                if (!inThrottle) { func.apply(this, args); inThrottle = true; setTimeout(() => inThrottle = false, limit); }
            };
        }

        // æ ¼å¼åŒ–æç›Š
        function formatPnL(pnl) {
            if (pnl == null) return { text: '--', color: '#94a3b8' };
            return { text: (pnl >= 0 ? '+' : '') + '$' + pnl.toFixed(2), color: pnl >= 0 ? '#22c55e' : '#ef4444' };
        }

        // æŒå€‰å¡ç‰‡æ¨¡æ¿
        function renderPositionCard(pos) {
            const typeClass = pos.type === 'long' ? 'position-long' : 'position-short';
            const typeIcon = pos.type === 'long' ? 'ğŸ“ˆ' : 'ğŸ“‰';
            const pnl = formatPnL(pos.pnl);
            return `<div class="position-card ${typeClass}">
                <div class="position-info"><div class="position-type">${typeIcon} ${pos.type.toUpperCase()}</div>
                <div class="position-details">Entry: ${pos.entryPrice?.toFixed(2) ?? '--'} | Vol: ${pos.volume?.toFixed(2) ?? '--'}</div></div>
                <div class="position-pnl"><div class="pnl-value" style="color: ${pnl.color}">${pnl.text}</div><div class="position-id">ID: ${pos.id ?? '--'}</div></div>
                <button class="btn-close-position" onclick="closePosition(${pos.id})">å¹³å€‰</button></div>`;
        }

        function updatePositionsList(positions) {
            document.getElementById('position-count').textContent = positions.length;
            document.getElementById('positions-list').innerHTML = positions.length === 0
                ? '<div class="no-positions">ç›®å‰ç„¡æŒå€‰</div>'
                : positions.map(renderPositionCard).join('');
        }

        // ç¸¾æ•ˆåœ–è¡¨
        function initEquityChart() {
            const canvas = document.getElementById('equity-chart');
            if (!canvas) return;
            equityChart = new Chart(canvas.getContext('2d'), {
                type: 'line',
                data: { labels: [], datasets: [{ label: 'æ·¨å€¼', data: [], borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', fill: true, tension: 0.4, pointRadius: 3 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#94a3b8' } }, x: { grid: { display: false }, ticks: { color: '#94a3b8' } } } }
            });
        }

        function updateEquityChart(trades) {
            if (!equityChart || !trades?.length) return;
            const sorted = [...trades].reverse();
            equityChart.data.labels = sorted.map((_, i) => `#${i + 1}`);
            equityChart.data.datasets[0].data = sorted.map(t => t.balance);
            equityChart.update('none');
        }

        // UI æ›´æ–°
        function updateUI(data) {
            const el = (id) => document.getElementById(id);
            const setConn = (text, cls) => { el('connection-status').textContent = text; el('connection-status').className = 'status-badge ' + cls; };
            if (data.connected && data.authenticated) setConn('ğŸŸ¢ å·²é€£ç·š', 'status-connected');
            else if (data.connected) setConn('ğŸŸ¡ é€£ç·šä¸­...', 'status-watching');
            else setConn('ğŸ”´ æœªé€£ç·š', 'status-disconnected');

            el('watching-status').textContent = data.isWatching ? 'ğŸ‘ï¸ ç›¯ç›¤ä¸­' : 'ğŸ’¤ å¾…æ©Ÿ';
            el('watching-status').className = 'status-badge ' + (data.isWatching ? 'status-watching' : 'status-idle');
            el('trade-status').textContent = data.todayTradeDone ? 'âœ… ä»Šæ—¥å·²äº¤æ˜“' : 'â³ ç­‰å¾…é€²å ´';
            el('trade-status').className = 'status-badge ' + (data.todayTradeDone ? 'status-connected' : 'status-idle');

            const curPrice = data.currentPrice ? data.currentPrice / PRICE_MULTIPLIER : null;
            const openPrice = data.openPrice ? data.openPrice / PRICE_MULTIPLIER : null;
            el('current-price').textContent = curPrice ? curPrice.toFixed(2) : '--';
            el('open-price').textContent = openPrice ? openPrice.toFixed(2) : '--';
            if (curPrice && openPrice) {
                const diff = curPrice - openPrice;
                el('price-diff').textContent = (diff > 0 ? '+' : '') + diff.toFixed(2);
                el('price-diff').className = diff > 0 ? 'text-green' : (diff < 0 ? 'text-red' : '');
            }

            el('balance').textContent = '$' + (data.balance || 0).toFixed(2);
            el('equity').textContent = '$' + (data.equity || data.balance || 0).toFixed(2);
            el('usedMargin').textContent = '$' + (data.usedMargin || 0).toFixed(2);
            el('freeMargin').textContent = '$' + (data.freeMargin || data.balance || 0).toFixed(2);
            el('win-rate').textContent = data.winRate || '--';
            el('wins').textContent = data.wins || 0;
            el('losses').textContent = data.losses || 0;
            el('leverage').textContent = data.leverage ? '1:' + data.leverage : '--';

            const eqEl = el('equity');
            eqEl.className = 'stat-value' + (data.unrealizedPnL > 0 ? ' text-green' : (data.unrealizedPnL < 0 ? ' text-red' : ''));

            if (data.config && !window.configLoaded) {
                ['entryOffset', 'longTP', 'shortTP', 'longSL', 'shortSL', 'lotSize', 'minsAfterOpen', 'baselineOffsetMinutes'].forEach(f => {
                    const e = el('cfg-' + f); if (e && data.config[f] !== undefined) e.value = data.config[f];
                });
                window.configLoaded = true;
            }

            updatePositionsList(data.positions || []);
            if (data.logs?.length) { el('logs').innerHTML = data.logs.map(l => `<div>${l}</div>`).join(''); }
            if (data.trades) updateEquityChart(data.trades);
        }

        const throttledUpdate = throttle(updateUI, 100);

        // Socket.IO
        function initSocketIO() {
            const script = document.createElement('script');
            script.src = '/socket.io/socket.io.js';
            script.onload = () => {
                socket = io();
                socket.on('connect', () => { socketConnected = true; document.getElementById('connection-status').textContent = 'ğŸŸ¢ å³æ™‚é€£ç·š'; document.getElementById('connection-status').className = 'status-badge status-connected'; });
                socket.on('disconnect', () => { socketConnected = false; });
                socket.on('initial-state', updateUI);
                socket.on('realtime-update', throttledUpdate);
                socket.on('account-update', d => { if (d.balance !== undefined) document.getElementById('balance').textContent = '$' + d.balance.toFixed(2); });
                socket.on('positions-update', d => updatePositionsList(d.positions || []));
                socket.on('new-log', msg => { const c = document.getElementById('logs'); const div = document.createElement('div'); div.textContent = msg; c.insertBefore(div, c.firstChild); while (c.children.length > 50) c.removeChild(c.lastChild); });
            };
            document.head.appendChild(script);
        }

        // API
        async function fetchStatus() {
            if (socketConnected && Date.now() - lastLogFetch < 10000) return;
            lastLogFetch = Date.now();
            try { const res = await fetch(API_URL + '/status'); const data = await res.json(); if (socketConnected) { if (data.logs) document.getElementById('logs').innerHTML = data.logs.map(l => `<div>${l}</div>`).join(''); } else updateUI(data); } catch (e) { console.debug('fetchStatus å¿½ç•¥:', e.message); }
        }

        async function doAction(action, config = null) {
            try {
                const body = { action }; if (config) body.config = config;
                const res = await fetch(API_URL + '/action', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
                const data = await res.json();
                if (data.success) updateUI(data.state); else alert('æ“ä½œå¤±æ•—: ' + (data.error || data.message || 'æœªçŸ¥éŒ¯èª¤'));
            } catch (e) { alert('è«‹æ±‚å¤±æ•—: ' + e.message); }
        }

        function toggleWatch() { doAction('toggleWatch'); }
        function resetDaily() { if (confirm('ç¢ºå®šè¦é‡ç½®ä»Šæ—¥äº¤æ˜“ç‹€æ…‹å—ï¼Ÿ')) doAction('reset'); }
        function closeAllPositions() { if (confirm('âš ï¸ ç¢ºå®šè¦ç·Šæ€¥å¹³å€‰æ‰€æœ‰æŒå€‰å—ï¼Ÿ')) doAction('closePositions'); }
        async function fetchOpenPrice() { const res = await fetch(API_URL + '/action', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'fetchOpenPrice' }) }); const data = await res.json(); if (data.success) { alert('âœ… åŸºæº–é»å·²å–å¾—'); updateUI(data.state); } else alert('âŒ ' + (data.message || 'å–å¾—åŸºæº–é»å¤±æ•—')); }
        async function closePosition(id) { if (!confirm(`ç¢ºå®šè¦å¹³å€‰æŒå€‰ ID: ${id} å—ï¼Ÿ`)) return; try { const res = await fetch(API_URL + '/action', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'closePosition', positionId: id }) }); const data = await res.json(); if (data.success) updateUI(data.state); else alert('å¹³å€‰å¤±æ•—: ' + (data.error || 'æœªçŸ¥éŒ¯èª¤')); } catch (e) { alert('è«‹æ±‚å¤±æ•—: ' + e.message); } }
        function saveConfig() { const cfg = {};['entryOffset', 'longTP', 'shortTP', 'longSL', 'shortSL', 'lotSize', 'minsAfterOpen', 'baselineOffsetMinutes'].forEach(f => cfg[f] = document.getElementById('cfg-' + f).value); doAction('updateConfig', cfg); alert('âœ… ç­–ç•¥åƒæ•¸å·²å„²å­˜'); }

        // åˆå§‹åŒ–
        initSocketIO();
        initEquityChart();
        fetchStatus();
        setInterval(fetchStatus, 2000);
    </script>
</body>

</html>